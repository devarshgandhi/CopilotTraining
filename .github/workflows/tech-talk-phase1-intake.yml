name: Tech Talk Automation - Phase 1 (Intake & Research)

on:
  issues:
    types: [opened, labeled]

jobs:
  intake:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'tech-talk') &&
      contains(github.event.issue.labels.*.name, 'tech-talk:intake')
    permissions:
      issues: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue fields
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Parse the issue body to extract fields
            const extractField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*([^#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const topic = extractField('Tech Talk Topic');
            const sourceUrls = extractField('Source URLs');
            const primaryQuestion = extractField('Primary Question');
            const audience = extractField('Target Audience');
            const duration = extractField('Expected Duration');
            
            core.setOutput('topic', topic);
            core.setOutput('source_urls', sourceUrls);
            core.setOutput('primary_question', primaryQuestion);
            core.setOutput('audience', audience);
            core.setOutput('duration', duration);
            
            return { topic, sourceUrls, primaryQuestion, audience, duration };

      - name: Create research directory
        run: |
          topic="${{ steps.extract.outputs.topic }}"
          mkdir -p "tech-talks/.research/${topic}"
          echo "Created research directory: tech-talks/.research/${topic}"

      - name: Save metadata
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const topic = '${{ steps.extract.outputs.topic }}';
            const metadata = {
              topic: topic,
              issue_number: context.issue.number,
              primary_question: '${{ steps.extract.outputs.primary_question }}',
              audience: '${{ steps.extract.outputs.audience }}',
              duration: '${{ steps.extract.outputs.duration }}',
              source_urls: '${{ steps.extract.outputs.source_urls }}'.split('\n').filter(u => u.trim()),
              phase1_started: new Date().toISOString(),
              phase1_completed: null,
              phase2_completed: null
            };
            
            fs.writeFileSync(
              `tech-talks/.research/${topic}/metadata.json`,
              JSON.stringify(metadata, null, 2)
            );

      - name: Validate source URLs
        id: validate
        run: |
          echo "Validating source URLs..."
          urls="${{ steps.extract.outputs.source_urls }}"
          
          # Check if URLs are accessible (basic validation)
          valid=true
          while IFS= read -r url; do
            if [[ -n "$url" && "$url" =~ ^https?:// ]]; then
              echo "Checking: $url"
              if ! curl -f -s -I "$url" > /dev/null 2>&1; then
                echo "‚ö†Ô∏è Warning: URL may be inaccessible: $url"
                valid=false
              fi
            fi
          done <<< "$urls"
          
          echo "validation_complete=true" >> $GITHUB_OUTPUT
          echo "all_valid=$valid" >> $GITHUB_OUTPUT

      - name: Initialize research document
        run: |
          topic="${{ steps.extract.outputs.topic }}"
          cat > "tech-talks/.research/${topic}/phase1-research.md" << 'EOF'
          # Research Findings for ${{ steps.extract.outputs.topic }}

          **Issue**: #${{ github.event.issue.number }}
          **Primary Question**: ${{ steps.extract.outputs.primary_question }}
          **Research Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---

          ## Source URLs

          ${{ steps.extract.outputs.source_urls }}

          ---

          ## Research Instructions

          This document will be populated by the tech-talk-generator agent in Phase 2.

          The agent should:
          1. Use **web_search** (not web_fetch) to research each URL
          2. For large content (>20K chars), process in sections
          3. Extract technical details: capabilities, architecture, examples
          4. Identify decision criteria and tradeoffs
          5. List visual assets (diagrams, screenshots)
          6. Note official documentation links
          7. Identify 2-5 primary artifacts
          8. Map 3-6 major technical sections

          ---

          ## Research Findings

          [Agent will populate this section in Phase 2]
          EOF

      - name: Commit research files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tech-talks/.research/
          git commit -m "Initialize research directory for tech-talk: ${{ steps.extract.outputs.topic }} (Issue #${{ github.event.issue.number }})"
          git push

      - name: Comment on issue - Phase 1 Complete
        uses: actions/github-script@v7
        with:
          script: |
            const validation = '${{ steps.validate.outputs.all_valid }}' === 'true';
            const status = validation ? '‚úÖ' : '‚ö†Ô∏è';
            const topic = '${{ steps.extract.outputs.topic }}';
            
            const comment = `## ${status} Phase 1: Intake Complete
            
            **Tech Talk Topic**: ${topic}
            **Primary Question**: ${{ steps.extract.outputs.primary_question }}
            **Target Audience**: ${{ steps.extract.outputs.audience }}
            **Duration**: ${{ steps.extract.outputs.duration }}
            
            ### Source URLs Validated
            ${{ steps.extract.outputs.source_urls }}
            
            ${validation ? '‚úÖ All URLs are accessible' : '‚ö†Ô∏è Some URLs may require authentication or VPN access'}
            
            ### üìÅ Research Storage
            
            Research files created at:
            - \`tech-talks/.research/${topic}/metadata.json\`
            - \`tech-talks/.research/${topic}/phase1-research.md\`
            
            [View Research Files](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/tech-talks/.research/${topic})
            
            ---
            
            **Next Steps**:
            - Phase 2 will begin automatically
            - Agent will research source URLs and populate research document
            - Agent will create content outline based on findings
            - You can review/edit research files before Phase 3
            - Estimated time: 10-15 minutes
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Progress to Phase 2
        uses: actions/github-script@v7
        with:
          script: |
            // Remove intake label, add planned label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'tech-talk:intake'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['tech-talk:planned']
            });

      - name: Assign to tech-talk-generator agent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Re-assign to ensure agent picks up the planned phase
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/assignees \
            --input - <<< '{
              "assignees": ["copilot-swe-agent[bot]"]
            }'
