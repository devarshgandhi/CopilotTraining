name: Tech Talk Automation - Phase 2 (Research & Plan)

on:
  issues:
    types: [labeled]

jobs:
  plan:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'tech-talk') &&
      contains(github.event.issue.labels.*.name, 'tech-talk:planned')
    permissions:
      issues: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Comment - Starting Phase 2
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ” Phase 2: Research & Planning Started
              
              The tech-talk-generator agent will now:
              1. Research all provided source URLs using **web_search** (handles large content)
              2. Extract key capabilities, architecture, and decision criteria
              3. Populate research findings in \`phase1-research.md\`
              4. Identify 2-5 primary artifacts (configs, code samples)
              5. Create content outline in \`phase2-plan.md\` following TEMPLATE.md
              6. Map 3-6 major technical sections with ðŸŽ¬ markers
              7. Assess content fitness (Relevant/Compelling/Actionable)
              
              **Estimated time**: 10-15 minutes
              
              Research files will be committed to the repository for your review.`
            });

      - name: Add instructions for agent
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Extract topic from issue
            const extractField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*([^#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const topic = extractField('Tech Talk Topic');
            
            const instructions = `
            @copilot-swe-agent[bot]
            
            Please complete Phase 2 (Research & Planning) for this tech talk.
            
            **Research Files Location**: \`tech-talks/.research/${topic}/\`
            
            ## Your Tasks:
            
            ### 1. Research Source URLs
            
            - Read \`metadata.json\` for source URLs and requirements
            - Use **web_search** (NOT web_fetch - it fails in sandbox)
            - For large content (>20K chars), process in logical sections:
              - Break into sections (introduction, features, examples, etc.)
              - Extract key technical details from each section
              - Synthesize findings into cohesive document
            - Focus on: capabilities, architecture, code examples, decision criteria
            
            ### 2. Populate Research Document
            
            Update \`phase1-research.md` with:
            - Key capabilities discovered
            - Architecture overview
            - Code examples and patterns
            - Decision criteria (when to use/not use)
            - Visual assets (diagrams, screenshots) with URLs
            - Official documentation links
            - Identified primary artifacts (2-5)
            - Proposed major sections (3-6)
            
            ### 3. Create Content Plan
            
            Create \`phase2-plan.md\` with:
            - The question this talk answers
            - Content fitness assessment (all ðŸŸ¢ required)
            - Outline of 3-6 major sections with ðŸŽ¬ markers
            - List of 2-5 key artifacts with purposes
            - 3-5 real-world use cases
            - Visual assets to include
            - Official documentation links
            
            Follow the structure in \`tech-talks/TEMPLATE.md\`.
            
            ### 4. Commit and Report
            
            - Commit both research and plan files
            - Post summary comment with links to files
            - **Do NOT add any labels** - human will review and approve
            
            **Important**: Use \`tech-talk-author\` skill for research and planning. Do NOT generate full README yet.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: instructions
            });
